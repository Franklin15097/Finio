#!/bin/bash

# ============================================================================
# Finio - ะััััะพะต ะพะฑะฝะพะฒะปะตะฝะธะต ะฝะฐ ัะตัะฒะตัะต
# ============================================================================
# ะญัะพั ัะบัะธะฟั ะฒัะฟะพะปะฝัะตั ะฑััััะพะต ะพะฑะฝะพะฒะปะตะฝะธะต ะฟัะธะปะพะถะตะฝะธั ะฝะฐ ัะตัะฒะตัะต:
# - ะะพะปััะฐะตั ะฟะพัะปะตะดะฝะธะต ะธะทะผะตะฝะตะฝะธั ะธะท GitHub
# - ะะฑะฝะพะฒะปัะตั ะทะฐะฒะธัะธะผะพััะธ
# - ะะตัะตัะพะฑะธัะฐะตั frontend ะธ backend
# - ะะตัะตะทะฐะฟััะบะฐะตั ัะตัะฒะธัั
# ============================================================================

set -e

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# ะะพะฝัะธะณััะฐัะธั
PROJECT_DIR="/var/www/studiofinance"

print_header() {
    echo -e "\n${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo -e "${BLUE}โ${NC} ${CYAN}$1${NC}"
    echo -e "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}\n"
}

print_success() {
    echo -e "${GREEN}โ${NC} $1"
}

print_info() {
    echo -e "${CYAN}โ${NC} $1"
}

print_header "๐ Finio - ะััััะพะต ะพะฑะฝะพะฒะปะตะฝะธะต"

# ะัะพะฒะตัะบะฐ ะดะธัะตะบัะพัะธะธ
if [ ! -d "$PROJECT_DIR" ]; then
    echo -e "${RED}โ${NC} ะะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ ะฝะต ะฝะฐะนะดะตะฝะฐ: $PROJECT_DIR"
    exit 1
fi

cd "$PROJECT_DIR"

# ะจะฐะณ 1: ะะพะปััะตะฝะธะต ะธะทะผะตะฝะตะฝะธะน
print_info "ะะพะปััะตะฝะธะต ะฟะพัะปะตะดะฝะธั ะธะทะผะตะฝะตะฝะธะน ะธะท GitHub..."
git pull origin main
print_success "ะะทะผะตะฝะตะฝะธั ะฟะพะปััะตะฝั"

# ะจะฐะณ 2: ะะฑะฝะพะฒะปะตะฝะธะต Frontend
print_info "ะะฑะฝะพะฒะปะตะฝะธะต Frontend..."
cd frontend
npm install --production
npm run build
cd ..
print_success "Frontend ะพะฑะฝะพะฒะปะตะฝ"

# ะจะฐะณ 3: ะะฑะฝะพะฒะปะตะฝะธะต Backend
print_info "ะะฑะฝะพะฒะปะตะฝะธะต Backend..."
cd backend
npm install --production
npm run build
cd ..
print_success "Backend ะพะฑะฝะพะฒะปะตะฝ"

# ะจะฐะณ 4: ะะตัะตะทะฐะฟััะบ ัะตัะฒะธัะพะฒ
print_info "ะะตัะตะทะฐะฟััะบ ัะตัะฒะธัะพะฒ..."
pm2 restart finio-backend
pm2 restart finio-bot
print_success "ะกะตัะฒะธัั ะฟะตัะตะทะฐะฟััะตะฝั"

# ะจะฐะณ 5: ะัะพะฒะตัะบะฐ ััะฐัััะฐ
print_info "ะัะพะฒะตัะบะฐ ััะฐัััะฐ ัะตัะฒะธัะพะฒ..."
sleep 2
pm2 status

print_header "โ ะะฑะฝะพะฒะปะตะฝะธะต ะทะฐะฒะตััะตะฝะพ!"

echo -e "${CYAN}๐ URLs:${NC}"
echo -e "   ${YELLOW}Frontend:${NC}     https://studiofinance.ru"
echo -e "   ${YELLOW}Backend API:${NC}  https://api.studiofinance.ru"
echo -e "   ${YELLOW}Telegram Bot:${NC} @FinanceStudio_bot"
echo ""
echo -e "${CYAN}๐ ะะพะปะตะทะฝัะต ะบะพะผะฐะฝะดั:${NC}"
echo -e "   ${YELLOW}ะะพะณะธ:${NC}         pm2 logs"
echo -e "   ${YELLOW}ะะพะฝะธัะพัะธะฝะณ:${NC}   pm2 monit"
echo -e "   ${YELLOW}ะกัะฐััั:${NC}       pm2 status"
echo ""
